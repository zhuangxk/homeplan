"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var app = getApp();
var index_1 = require("../../../api/index");
var util_1 = require("../../../utils/util");
var dialog_1 = require("@vant/weapp/dialog/dialog");
Component({
    data: {
        keyboardShow: false,
        CustomBar: app.globalData.CustomBar,
        bills: [],
        dateMap: {},
        monthMap: {},
        dateMapKeys: [],
        loading: false,
        total: 0,
        slideReset: true,
        params: {
            "page": 1,
            "page_size": -1
        },
        localDay: ["日", "一", "二", "三", "四", "五", "六"],
        actionType: 'add',
        curEditItem: {},
        lastTouchId: 0,
    },
    properties: {
        ledgerId: {
            type: Number
        }
    },
    lifetimes: {},
    observers: {
        ledgerId: function () {
            this.getBills();
        }
    },
    methods: {
        onClick: function (e) {
            var bill = e.currentTarget.dataset.item;
            wx.navigateTo({
                url: '/pages/ledger/bill_detail/bill_detail',
                events: {
                    acceptDataFromOpenedPage: function (data) {
                        console.log(data);
                    },
                    someEvent: function (data) {
                        console.log(data);
                    }
                },
                success: function (res) {
                    res.eventChannel.emit('acceptDataFromOpenerPage', { bill: bill });
                }
            });
        },
        getBills: function () {
            var _this = this;
            if (!this.data.ledgerId) {
                return;
            }
            if (this.data.loading) {
                return;
            }
            this.data.loading = true;
            wx.showLoading({
                title: '加载中'
            });
            index_1.getBills(this.data.ledgerId, this.data.params).then(function (res) {
                _this.handleBillsRes(res);
                wx.hideLoading();
                _this.data.loading = false;
            });
        },
        handleBillsRes: function (res) {
            var _this = this;
            var list = res.list;
            var dateCount = res.date_count;
            var monthCount = res.month_count;
            var dateMap = {};
            dateCount.forEach(function (item) {
                dateMap[_this.getDateKey(item.date)] = {
                    list: [],
                    total: item.total,
                    sumIn: item.sum_in,
                    sumOut: item.sum_out,
                };
            });
            list.forEach(function (item) {
                var date = dateMap[_this.getDateKey(item.bill_time)];
                if (date.list) {
                    date.list.push(item);
                }
                else {
                    wx.showToast({
                        title: "计数出错"
                    });
                }
            });
            this.setData({
                total: res.total,
                dateMap: dateMap,
                dateMapKeys: Object.keys(dateMap),
                monthMap: monthCount[0],
            });
        },
        getDateKey: function (iosdate) {
            var date = new Date(iosdate);
            var dateKey = util_1.formatMonthDate(date) + "  星期" + this.data.localDay[date.getDay()];
            if (util_1.formatMonthDate(date) == util_1.formatMonthDate(new Date())) {
                dateKey = "今日  星期" + this.data.localDay[new Date().getDay()];
            }
            return dateKey;
        },
        onAdd: function () {
            this.setData({
                curEditItem: {},
                actionType: 'add',
                keyboardShow: true
            });
        },
        onClose: function () {
            this.setData({
                keyboardShow: false
            });
        },
        onSave: function () {
            this.setData({
                keyboardShow: false,
                slideReset: true,
            });
            this.getBills();
        },
        onClickDelete: function (e) {
            var self = this;
            var id = e.currentTarget.dataset.id;
            dialog_1.default({
                showCancelButton: true,
                title: '提示',
                message: '确定要删除吗？',
                asyncClose: true
            })
                .then(function () {
                if (dialog_1.default.confirm)
                    index_1.delBill(id).then(function (_) {
                        if (dialog_1.default.close)
                            dialog_1.default.close();
                        self.getBills();
                    });
            })
                .catch(function () {
                if (dialog_1.default.close)
                    dialog_1.default.close();
            });
        },
        onClickEdit: function (e) {
            this.setData({
                curEditItem: e.currentTarget.dataset.item,
                actionType: 'edit',
                keyboardShow: true
            });
        },
        onTouchstart: function (e) {
            var id = e.currentTarget.dataset.id;
            if (id == this.data.lastTouchId) {
                return;
            }
            this.setData({
                lastTouchId: id,
                slideReset: true,
            });
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmlsbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImJpbGwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFNLEdBQUcsR0FBRyxNQUFNLEVBQWdCLENBQUE7QUFDbEMsNENBQXNEO0FBQ3RELDRDQUFxRDtBQUNyRCxvREFBOEM7QUFHOUMsU0FBUyxDQUFDO0lBQ04sSUFBSSxFQUFFO1FBQ0YsWUFBWSxFQUFFLEtBQUs7UUFDbkIsU0FBUyxFQUFFLEdBQUcsQ0FBQyxVQUFVLENBQUMsU0FBUztRQUNuQyxLQUFLLEVBQUUsRUFBYztRQUNyQixPQUFPLEVBQUUsRUFBK0I7UUFDeEMsUUFBUSxFQUFFLEVBQStCO1FBQ3pDLFdBQVcsRUFBRSxFQUFtQjtRQUNoQyxPQUFPLEVBQUUsS0FBSztRQUNkLEtBQUssRUFBRSxDQUFDO1FBQ1IsVUFBVSxFQUFFLElBQUk7UUFDaEIsTUFBTSxFQUFFO1lBQ0osTUFBTSxFQUFFLENBQUM7WUFDVCxXQUFXLEVBQUUsQ0FBQyxDQUFDO1NBQ2xCO1FBQ0QsUUFBUSxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBQyxHQUFHLEVBQUMsR0FBRyxFQUFDLEdBQUcsRUFBQyxHQUFHLEVBQUMsR0FBRyxDQUFDO1FBQ3hDLFVBQVUsRUFBRSxLQUFLO1FBQ2pCLFdBQVcsRUFBRSxFQUFFO1FBQ2YsV0FBVyxFQUFFLENBQUM7S0FDakI7SUFDRCxVQUFVLEVBQUU7UUFDUixRQUFRLEVBQUU7WUFDTixJQUFJLEVBQUUsTUFBTTtTQUNmO0tBQ0o7SUFDRCxTQUFTLEVBQUUsRUFJVjtJQUNELFNBQVMsRUFBRTtRQUNQLFFBQVEsRUFBUjtZQUNJLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQTtRQUNuQixDQUFDO0tBQ0o7SUFDRCxPQUFPLEVBQUU7UUFDTCxPQUFPLEVBQVAsVUFBUSxDQUFDO1lBQ0wsSUFBTSxJQUFJLEdBQUksQ0FBQyxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFBO1lBQzFDLEVBQUUs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SUFwcE9wdGlvblxyXG5pbXBvcnQgeyBnZXRCaWxscywgZGVsQmlsbCB9IGZyb20gXCIuLi8uLi8uLi9hcGkvaW5kZXhcIlxyXG5pbXBvcnQgeyBmb3JtYXRNb250aERhdGUgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvdXRpbFwiXHJcbmltcG9ydCBEaWFsb2cgZnJvbSBcIkB2YW50L3dlYXBwL2RpYWxvZy9kaWFsb2dcIlxyXG4vLyBjb25zdCBEaWFsb2cgPSByZXF1aXJlKCdAdmFudC93ZWFwcC9kaWFsb2cvZGlhbG9nJylcclxuXHJcbkNvbXBvbmVudCh7XHJcbiAgICBkYXRhOiB7XHJcbiAgICAgICAga2V5Ym9hcmRTaG93OiBmYWxzZSxcclxuICAgICAgICBDdXN0b21CYXI6IGFwcC5nbG9iYWxEYXRhLkN1c3RvbUJhcixcclxuICAgICAgICBiaWxsczogW10gYXMgQW55QXJyYXksXHJcbiAgICAgICAgZGF0ZU1hcDoge30gYXMgUmVjb3JkPHN0cmluZywgQW55T2JqZWN0PixcclxuICAgICAgICBtb250aE1hcDoge30gYXMgUmVjb3JkPHN0cmluZywgQW55T2JqZWN0PixcclxuICAgICAgICBkYXRlTWFwS2V5czogW10gYXMgQXJyYXk8c3RyaW5nPixcclxuICAgICAgICBsb2FkaW5nOiBmYWxzZSxcclxuICAgICAgICB0b3RhbDogMCxcclxuICAgICAgICBzbGlkZVJlc2V0OiB0cnVlLFxyXG4gICAgICAgIHBhcmFtczoge1xyXG4gICAgICAgICAgICBcInBhZ2VcIjogMSxcclxuICAgICAgICAgICAgXCJwYWdlX3NpemVcIjogLTFcclxuICAgICAgICB9LFxyXG4gICAgICAgIGxvY2FsRGF5OiBbXCLml6VcIiwgXCLkuIBcIixcIuS6jFwiLFwi5LiJXCIsXCLlm5tcIixcIuS6lFwiLFwi5YWtXCJdLFxyXG4gICAgICAgIGFjdGlvblR5cGU6ICdhZGQnLFxyXG4gICAgICAgIGN1ckVkaXRJdGVtOiB7fSxcclxuICAgICAgICBsYXN0VG91Y2hJZDogMCxcclxuICAgIH0sXHJcbiAgICBwcm9wZXJ0aWVzOiB7XHJcbiAgICAgICAgbGVkZ2VySWQ6IHsgXHJcbiAgICAgICAgICAgIHR5cGU6IE51bWJlclxyXG4gICAgICAgIH0gIFxyXG4gICAgfSxcclxuICAgIGxpZmV0aW1lczoge1xyXG4gICAgICAgIC8vIHJlYWR5KCk6IHZvaWR7XHJcbiAgICAgICAgLy8gICB0aGlzLmdldEJpbGxzKClcclxuICAgICAgICAvLyB9XHJcbiAgICB9LFxyXG4gICAgb2JzZXJ2ZXJzOiB7XHJcbiAgICAgICAgbGVkZ2VySWQoKTogdm9pZCB7XHJcbiAgICAgICAgICAgIHRoaXMuZ2V0QmlsbHMoKSBcclxuICAgICAgICB9XHJcbiAgICB9LFxyXG4gICAgbWV0aG9kczoge1xyXG4gICAgICAgIG9uQ2xpY2soZSk6IHZvaWR7XHJcbiAgICAgICAgICAgIGNvbnN0IGJpbGwgPSAgZS5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaXRlbVxyXG4gICAgICAgICAgICB3eC5uYXZpZ2F0ZVRvKHtcclxuICAgICAgICAgICAgICAgIHVybDogJy9wYWdlcy9sZWRnZXIvYmlsbF9kZXRhaWwvYmlsbF9kZXRhaWwnLFxyXG4gICAgICAgICAgICAgICAgZXZlbnRzOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8g5Li65oyH5a6a5LqL5Lu25re75Yqg5LiA5Liq55uR5ZCs5Zmo77yM6I635Y+W6KKr5omT5byA6aG16Z2i5Lyg6YCB5Yiw5b2T5YmN6aG16Z2i55qE5pWw5o2uXHJcbiAgICAgICAgICAgICAgICAgICAgYWNjZXB0RGF0YUZyb21PcGVuZWRQYWdlOiBmdW5jdGlvbihkYXRhOiBhbnkpOiB2b2lkIHtcclxuICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGRhdGEpXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBzb21lRXZlbnQ6IGZ1bmN0aW9uKGRhdGE6IGFueSk6IHZvaWQge1xyXG4gICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZGF0YSlcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKHJlcykge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIOmAmui/h2V2ZW50Q2hhbm5lbOWQkeiiq+aJk+W8gOmhtemdouS8oOmAgeaVsOaNrlxyXG4gICAgICAgICAgICAgICAgICAgIHJlcy5ldmVudENoYW5uZWwuZW1pdCgnYWNjZXB0RGF0YUZyb21PcGVuZXJQYWdlJywgeyBiaWxsOiBiaWxsIH0pXHJcbiAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9LFxyXG4gICAgICAgIGdldEJpbGxzKCk6IHZvaWR7XHJcbiAgICAgICAgICAgIGlmKCF0aGlzLmRhdGEubGVkZ2VySWQpe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYodGhpcy5kYXRhLmxvYWRpbmcpe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5kYXRhLmxvYWRpbmcgPSB0cnVlXHJcbiAgICAgICAgICAgIHd4LnNob3dMb2FkaW5nKHtcclxuICAgICAgICAgICAgICAgIHRpdGxlOiAn5Yqg6L295LitJ1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICBnZXRCaWxscyh0aGlzLmRhdGEubGVkZ2VySWQsIHRoaXMuZGF0YS5wYXJhbXMpLnRoZW4ocmVzPT57XHJcbiAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUJpbGxzUmVzKHJlcylcclxuICAgICAgICAgICAgICAgIHd4LmhpZGVMb2FkaW5nKClcclxuICAgICAgICAgICAgICAgIHRoaXMuZGF0YS5sb2FkaW5nID0gZmFsc2VcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9LFxyXG4gICAgICAgIGhhbmRsZUJpbGxzUmVzKHJlczogQW55T2JqZWN0KTogdm9pZHtcclxuICAgICAgICAgICAgY29uc3QgbGlzdCA9IHJlcy5saXN0IGFzIEFueUFycmF5XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGVDb3VudCA9IHJlcy5kYXRlX2NvdW50IGFzIEFueUFycmF5XHJcbiAgICAgICAgICAgIGNvbnN0IG1vbnRoQ291bnQgPSByZXMubW9udGhfY291bnQgYXMgQW55QXJyYXlcclxuICAgICAgICAgICAgY29uc3QgZGF0ZU1hcCA9IHt9IGFzIFJlY29yZDxzdHJpbmcsIEFueU9iamVjdD5cclxuICAgICAgICAgICAgZGF0ZUNvdW50LmZvckVhY2goaXRlbT0+e1xyXG4gICAgICAgICAgICAgICAgZGF0ZU1hcFt0aGlzLmdldERhdGVLZXkoaXRlbS5kYXRlKV0gPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGlzdDpbXSxcclxuICAgICAgICAgICAgICAgICAgICB0b3RhbDogaXRlbS50b3RhbCxcclxuICAgICAgICAgICAgICAgICAgICBzdW1JbjogaXRlbS5zdW1faW4sXHJcbiAgICAgICAgICAgICAgICAgICAgc3VtT3V0OiBpdGVtLnN1bV9vdXQsXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBsaXN0LmZvckVhY2goIGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZGF0ZSA9IGRhdGVNYXBbdGhpcy5nZXREYXRlS2V5KGl0ZW0uYmlsbF90aW1lKV1cclxuICAgICAgICAgICAgICAgIGlmKGRhdGUubGlzdCl7XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0ZS5saXN0LnB1c2goaXRlbSlcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgd3guc2hvd1RvYXN0KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGU6IFwi6K6h5pWw5Ye66ZSZXCJcclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICAgICAgdG90YWw6IHJlcy50b3RhbCxcclxuICAgICAgICAgICAgICAgIGRhdGVNYXAsXHJcbiAgICAgICAgICAgICAgICBkYXRlTWFwS2V5czogT2JqZWN0LmtleXMoZGF0ZU1hcCksXHJcbiAgICAgICAgICAgICAgICBtb250aE1hcDogbW9udGhDb3VudFswXSxcclxuICAgICAgICAgICAgfSlcclxuICAgICAgIFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZ2V0RGF0ZUtleShpb3NkYXRlOiBzdHJpbmcpOiBzdHJpbmd7XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZShpb3NkYXRlKVxyXG4gICAgICAgICAgICBsZXQgZGF0ZUtleSA9IGZvcm1hdE1vbnRoRGF0ZShkYXRlKSArIFwiICDmmJ/mnJ9cIiArIHRoaXMuZGF0YS5sb2NhbERheVtkYXRlLmdldERheSgpXVxyXG4gICAgICAgICAgICBpZihmb3JtYXRNb250aERhdGUoZGF0ZSkgPT0gZm9ybWF0TW9udGhEYXRlKG5ldyBEYXRlKCkpKXtcclxuICAgICAgICAgICAgICAgIGRhdGVLZXkgPSBcIuS7iuaXpSAg5pif5pyfXCIgKyB0aGlzLmRhdGEubG9jYWxEYXlbbmV3IERhdGUoKS5nZXREYXkoKV1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gZGF0ZUtleVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgb25BZGQoKTogdm9pZHtcclxuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgICAgIGN1ckVkaXRJdGVtOiB7fSxcclxuICAgICAgICAgICAgICAgIGFjdGlvblR5cGU6ICdhZGQnLFxyXG4gICAgICAgICAgICAgICAga2V5Ym9hcmRTaG93OiB0cnVlXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSxcclxuICBcclxuICAgICAgICBvbkNsb3NlKCk6IHZvaWR7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICBrZXlib2FyZFNob3c6IGZhbHNlXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgb25TYXZlKCk6IHZvaWR7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICBrZXlib2FyZFNob3c6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgc2xpZGVSZXNldDogdHJ1ZSxcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgdGhpcy5nZXRCaWxscygpXHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgb25DbGlja0RlbGV0ZShlKTogdm9pZHtcclxuICAgICAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXNcclxuICAgICAgICAgICAgY29uc3QgaWQgPSBlLmN1cnJlbnRUYXJnZXQuZGF0YXNldC5pZFxyXG4gICAgICAgICAgICBEaWFsb2coe1xyXG4gICAgICAgICAgICAgICAgc2hvd0NhbmNlbEJ1dHRvbjogdHJ1ZSxcclxuICAgICAgICAgICAgICAgIHRpdGxlOiAn5o+Q56S6JyxcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICfnoa7lrpropoHliKDpmaTlkJfvvJ8nLFxyXG4gICAgICAgICAgICAgICAgYXN5bmNDbG9zZTogdHJ1ZVxyXG4gICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmKERpYWxvZy5jb25maXJtKVxyXG4gICAgICAgICAgICAgICAgICAgIGRlbEJpbGwoaWQpLnRoZW4oXz0+e1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZihEaWFsb2cuY2xvc2UpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIERpYWxvZy5jbG9zZSgpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZ2V0QmlsbHMoKVxyXG4gICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIClcclxuICAgICAgICAgICAgLmNhdGNoKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmKERpYWxvZy5jbG9zZSlcclxuICAgICAgICAgICAgICAgIERpYWxvZy5jbG9zZSgpXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIG9uQ2xpY2tFZGl0KGUpOiB2b2lke1xyXG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICAgICAgY3VyRWRpdEl0ZW06IGUuY3VycmVudFRhcmdldC5kYXRhc2V0Lml0ZW0sXHJcbiAgICAgICAgICAgICAgICBhY3Rpb25UeXBlOiAnZWRpdCcsXHJcbiAgICAgICAgICAgICAgICBrZXlib2FyZFNob3c6IHRydWVcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICBvblRvdWNoc3RhcnQoZSl7XHJcbiAgICAgICAgICAgIGNvbnN0IGlkID0gZS5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaWRcclxuICAgICAgICAgICAgaWYoaWQgPT0gdGhpcy5kYXRhLmxhc3RUb3VjaElkKXtcclxuICAgICAgICAgICAgICAgIHJldHVyblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICBsYXN0VG91Y2hJZDogaWQsXHJcbiAgICAgICAgICAgICAgICBzbGlkZVJlc2V0OiB0cnVlLFxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH1cclxuXHJcblxyXG4gICAgfVxyXG5cclxufSlcclxuXHJcbmV4cG9ydCB7IH1cclxuXHJcbiJdfQ==