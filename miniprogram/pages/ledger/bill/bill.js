"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var app = getApp();
var index_1 = require("../../../api/index");
var util_1 = require("../../../utils/util");
var dialog_1 = require("@vant/weapp/dialog/dialog");
var year = new Date().getFullYear();
var month = new Date().getMonth();
Component({
    data: {
        keyboardShow: false,
        CustomBar: app.globalData.CustomBar,
        bills: [],
        dateMap: {},
        monthMap: {},
        dateMapKeys: [],
        loading: false,
        total: 0,
        slideReset: true,
        params: {
            "year": year,
            "month": month + 1,
            "page": 1,
            "page_size": -1
        },
        localDay: ["日", "一", "二", "三", "四", "五", "六"],
        actionType: 'add',
        curEditItem: {},
        lastTouchId: 0,
        pickerVal: year + '年' + (month + 1) + '月',
        months: [
            {
                values: [year - 2 + '年', year - 1 + '年', year + '年'],
                defaultIndex: 2
            },
            {
                values: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
                defaultIndex: month
            }
        ],
        monthShow: false
    },
    properties: {
        ledgerId: {
            type: Number
        }
    },
    lifetimes: {},
    observers: {
        ledgerId: function () {
            this.getBills();
        }
    },
    methods: {
        onClick: function (e) {
            var bill = e.currentTarget.dataset.item;
            wx.navigateTo({
                url: '/pages/ledger/bill_detail/bill_detail',
                events: {
                    acceptDataFromOpenedPage: function (data) {
                        console.log(data);
                    },
                    someEvent: function (data) {
                        console.log(data);
                    }
                },
                success: function (res) {
                    res.eventChannel.emit('acceptDataFromOpenerPage', { bill: bill });
                }
            });
        },
        getBills: function () {
            var _this = this;
            if (!this.data.ledgerId) {
                return;
            }
            if (this.data.loading) {
                return;
            }
            this.setData({
                loading: true
            });
            wx.showLoading({
                title: '加载中'
            });
            index_1.getBills(this.data.ledgerId, this.data.params).then(function (res) {
                _this.handleBillsRes(res);
                wx.hideLoading();
                _this.setData({
                    loading: false
                });
            });
        },
        handleBillsRes: function (res) {
            var _this = this;
            var list = res.list;
            var dateCount = res.date_count;
            var monthCount = res.month_count;
            var dateMap = {};
            dateCount.forEach(function (item) {
                dateMap[_this.getDateKey(item.date)] = {
                    list: [],
                    total: item.total,
                    sumIn: item.sum_in,
                    sumOut: item.sum_out,
                };
            });
            list.forEach(function (item) {
                var date = dateMap[_this.getDateKey(item.bill_time)];
                if (date.list) {
                    date.list.push(item);
                }
                else {
                    wx.showToast({
                        title: "计数出错"
                    });
                }
            });
            this.setData({
                total: res.total,
                dateMap: dateMap,
                dateMapKeys: Object.keys(dateMap),
                monthMap: monthCount[0] || {},
            });
        },
        getDateKey: function (iosdate) {
            var date = new Date(iosdate);
            var dateKey = util_1.formatMonthDate(date) + "  星期" + this.data.localDay[date.getDay()];
            if (util_1.formatMonthDate(date) == util_1.formatMonthDate(new Date())) {
                dateKey = "今日  星期" + this.data.localDay[new Date().getDay()];
            }
            return dateKey;
        },
        onAdd: function () {
            this.setData({
                curEditItem: {},
                actionType: 'add',
                keyboardShow: true
            });
        },
        onClose: function () {
            this.setData({
                keyboardShow: false
            });
        },
        onSave: function () {
            this.setData({
                keyboardShow: false,
                slideReset: true,
            });
            this.getBills();
        },
        onClickDelete: function (e) {
            var self = this;
            var id = e.currentTarget.dataset.id;
            dialog_1.default({
                showCancelButton: true,
                title: '提示',
                message: '确定要删除吗？',
                asyncClose: true
            })
                .then(function () {
                if (dialog_1.default.confirm)
                    index_1.delBill(id).then(function (_) {
                        if (dialog_1.default.close)
                            dialog_1.default.close();
                        self.getBills();
                    });
            })
                .catch(function () {
                if (dialog_1.default.close)
                    dialog_1.default.close();
            });
        },
        onClickEdit: function (e) {
            this.setData({
                curEditItem: e.currentTarget.dataset.item,
                actionType: 'edit',
                keyboardShow: true
            });
        },
        onTouchstart: function (e) {
            var id = e.currentTarget.dataset.id;
            if (id == this.data.lastTouchId) {
                return;
            }
            this.setData({
                lastTouchId: id,
                slideReset: true,
            });
        },
        onMonthCancel: function () {
            this.setData({
                monthShow: false
            });
        },
        onMonthShow: function () {
            this.setData({
                monthShow: true
            });
        },
        onMonthConfirm: function (e) {
            var _this = this;
            var _a = e.detail.index, yi = _a[0], mi = _a[1];
            this.setData({
                monthShow: false,
                pickerVal: [year - 2, year - 1, year][yi] + '年' + (mi + 1) + '月',
                params: {
                    "page_size": -1,
                    page: 1,
                    month: mi + 1,
                    year: [year - 2, year - 1, year][yi]
                }
            }, function () {
                _this.getBills();
            });
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmlsbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImJpbGwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFNLEdBQUcsR0FBRyxNQUFNLEVBQWdCLENBQUE7QUFDbEMsNENBQXNEO0FBQ3RELDRDQUFxRDtBQUNyRCxvREFBOEM7QUFHOUMsSUFBTSxJQUFJLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQTtBQUNyQyxJQUFNLEtBQUssR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLFFBQVEsRUFBRSxDQUFBO0FBQ25DLFNBQVMsQ0FBQztJQUNOLElBQUksRUFBRTtRQUNGLFlBQVksRUFBRSxLQUFLO1FBQ25CLFNBQVMsRUFBRSxHQUFHLENBQUMsVUFBVSxDQUFDLFNBQVM7UUFDbkMsS0FBSyxFQUFFLEVBQWM7UUFDckIsT0FBTyxFQUFFLEVBQStCO1FBQ3hDLFFBQVEsRUFBRSxFQUErQjtRQUN6QyxXQUFXLEVBQUUsRUFBbUI7UUFDaEMsT0FBTyxFQUFFLEtBQUs7UUFDZCxLQUFLLEVBQUUsQ0FBQztRQUNSLFVBQVUsRUFBRSxJQUFJO1FBQ2hCLE1BQU0sRUFBRTtZQUNKLE1BQU0sRUFBRSxJQUFJO1lBQ1osT0FBTyxFQUFFLEtBQUssR0FBRSxDQUFDO1lBQ2pCLE1BQU0sRUFBRSxDQUFDO1lBQ1QsV0FBVyxFQUFFLENBQUMsQ0FBQztTQUNsQjtRQUNELFFBQVEsRUFBRSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUMsR0FBRyxFQUFDLEdBQUcsRUFBQyxHQUFHLEVBQUMsR0FBRyxFQUFDLEdBQUcsQ0FBQztRQUN4QyxVQUFVLEVBQUUsS0FBSztRQUNqQixXQUFXLEVBQUUsRUFBRTtRQUNmLFdBQVcsRUFBRSxDQUFDO1FBQ2QsU0FBUyxFQUFFLElBQUksR0FBRyxHQUFHLEdBQUcsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEdBQUcsR0FBRztRQUN6QyxNQUFNLEVBQUU7WUFDSjtnQkFDSSxNQUFNLEVBQUcsQ0FB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LEVBQUUsSUFBSSxHQUFHLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxFQUFFLEdBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRztnQkFDOUQsTUFBTSxFQUFFO29CQUNKLFdBQVcsRUFBRSxDQUFDLENBQUM7b0JBQ2YsSUFBSSxFQUFDLENBQUM7b0JBQ04sS0FBSyxFQUFFLEVBQUUsR0FBRyxDQUFDO29CQUNiLElBQUksRUFBRSxDQUFDLElBQUksR0FBRyxDQUFDLEVBQUUsSUFBSSxHQUFHLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxFQUFFLENBQUM7aUJBQ3ZDO2FBQ0osRUFBRTtnQkFDQyxLQUFJLENBQUMsUUFBUSxFQUFFLENBQUE7WUFDbkIsQ0FBQyxDQUFDLENBQUE7UUFDTixDQUFDO0tBR0o7Q0FFSixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBhcHAgPSBnZXRBcHAoKSBhcyBJQXBwT3B0aW9uXHJcbmltcG9ydCB7IGdldEJpbGxzLCBkZWxCaWxsIH0gZnJvbSBcIi4uLy4uLy4uL2FwaS9pbmRleFwiXHJcbmltcG9ydCB7IGZvcm1hdE1vbnRoRGF0ZSB9IGZyb20gXCIuLi8uLi8uLi91dGlscy91dGlsXCJcclxuaW1wb3J0IERpYWxvZyBmcm9tIFwiQHZhbnQvd2VhcHAvZGlhbG9nL2RpYWxvZ1wiXHJcbi8vIGNvbnN0IERpYWxvZyA9IHJlcXVpcmUoJ0B2YW50L3dlYXBwL2RpYWxvZy9kaWFsb2cnKVxyXG5cclxuY29uc3QgeWVhciA9IG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKVxyXG5jb25zdCBtb250aCA9IG5ldyBEYXRlKCkuZ2V0TW9udGgoKVxyXG5Db21wb25lbnQoe1xyXG4gICAgZGF0YToge1xyXG4gICAgICAgIGtleWJvYXJkU2hvdzogZmFsc2UsXHJcbiAgICAgICAgQ3VzdG9tQmFyOiBhcHAuZ2xvYmFsRGF0YS5DdXN0b21CYXIsXHJcbiAgICAgICAgYmlsbHM6IFtdIGFzIEFueUFycmF5LFxyXG4gICAgICAgIGRhdGVNYXA6IHt9IGFzIFJlY29yZDxzdHJpbmcsIEFueU9iamVjdD4sXHJcbiAgICAgICAgbW9udGhNYXA6IHt9IGFzIFJlY29yZDxzdHJpbmcsIEFueU9iamVjdD4sXHJcbiAgICAgICAgZGF0ZU1hcEtleXM6IFtdIGFzIEFycmF5PHN0cmluZz4sXHJcbiAgICAgICAgbG9hZGluZzogZmFsc2UsXHJcbiAgICAgICAgdG90YWw6IDAsXHJcbiAgICAgICAgc2xpZGVSZXNldDogdHJ1ZSxcclxuICAgICAgICBwYXJhbXM6IHtcclxuICAgICAgICAgICAgXCJ5ZWFyXCI6IHllYXIsXHJcbiAgICAgICAgICAgIFwibW9udGhcIjogbW9udGggKzEsXHJcbiAgICAgICAgICAgIFwicGFnZVwiOiAxLFxyXG4gICAgICAgICAgICBcInBhZ2Vfc2l6ZVwiOiAtMVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgbG9jYWxEYXk6IFtcIuaXpVwiLCBcIuS4gFwiLFwi5LqMXCIsXCLkuIlcIixcIuWbm1wiLFwi5LqUXCIsXCLlha1cIl0sXHJcbiAgICAgICAgYWN0aW9uVHlwZTogJ2FkZCcsXHJcbiAgICAgICAgY3VyRWRpdEl0ZW06IHt9LFxyXG4gICAgICAgIGxhc3RUb3VjaElkOiAwLFxyXG4gICAgICAgIHBpY2tlclZhbDogeWVhciArICflubQnICsgKG1vbnRoICsgMSkgKyAn5pyIJyxcclxuICAgICAgICBtb250aHM6IFtcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgdmFsdWVzOiAgW3llYXIgLSAyICsgJ+W5tCcsIHllYXIgLSAxICsgJ+W5tCcsIHllYXIgKyAn5bm0J10sXHJcbiAgICAgICAgICAgICAgICBkZWZhdWx0SW5kZXg6IDJcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgdmFsdWVzOiBbXCLkuIDmnIhcIixcIuS6jOaciFwiLFwi5LiJ5pyIXCIsXCLlm5vmnIhcIixcIuS6lOaciFwiLFwi5YWt5pyIXCIsXCLkuIPmnIhcIixcIuWFq+aciFwiLFwi5Lmd5pyIXCIsXCLljYHmnIhcIixcIuWNgeS4gOaciFwiLFwi5Y2B5LqM5pyIXCJdLFxyXG4gICAgICAgICAgICAgICAgZGVmYXVsdEluZGV4OiBtb250aFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgXSxcclxuICAgICAgICBtb250aFNob3c6IGZhbHNlXHJcbiAgICB9LFxyXG4gICAgcHJvcGVydGllczoge1xyXG4gICAgICAgIGxlZGdlcklkOiB7IFxyXG4gICAgICAgICAgICB0eXBlOiBOdW1iZXJcclxuICAgICAgICB9ICBcclxuICAgIH0sXHJcbiAgICBsaWZldGltZXM6IHtcclxuICAgICAgICAvLyByZWFkeSgpOiB2b2lke1xyXG4gICAgICAgIC8vICAgdGhpcy5nZXRCaWxscygpXHJcbiAgICAgICAgLy8gfVxyXG4gICAgfSxcclxuICAgIG9ic2VydmVyczoge1xyXG4gICAgICAgIGxlZGdlcklkKCk6IHZvaWQge1xyXG4gICAgICAgICAgICB0aGlzLmdldEJpbGxzKCkgXHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuICAgIG1ldGhvZHM6IHtcclxuICAgICAgICBvbkNsaWNrKGUpOiB2b2lke1xyXG4gICAgICAgICAgICBjb25zdCBiaWxsID0gIGUuY3VycmVudFRhcmdldC5kYXRhc2V0Lml0ZW1cclxuICAgICAgICAgICAgd3gubmF2aWdhdGVUbyh7XHJcbiAgICAgICAgICAgICAgICB1cmw6ICcvcGFnZXMvbGVkZ2VyL2JpbGxfZGV0YWlsL2JpbGxfZGV0YWlsJyxcclxuICAgICAgICAgICAgICAgIGV2ZW50czoge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIOS4uuaMh+WumuS6i+S7tua3u+WKoOS4gOS4quebkeWQrOWZqO+8jOiOt+WPluiiq+aJk+W8gOmhtemdouS8oOmAgeWIsOW9k+WJjemhtemdoueahOaVsOaNrlxyXG4gICAgICAgICAgICAgICAgICAgIGFjY2VwdERhdGFGcm9tT3BlbmVkUGFnZTogZnVuY3Rpb24oZGF0YTogYW55KTogdm9pZCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhkYXRhKVxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgc29tZUV2ZW50OiBmdW5jdGlvbihkYXRhOiBhbnkpOiB2b2lkIHtcclxuICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGRhdGEpXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbihyZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyDpgJrov4dldmVudENoYW5uZWzlkJHooqvmiZPlvIDpobXpnaLkvKDpgIHmlbDmja5cclxuICAgICAgICAgICAgICAgICAgICByZXMuZXZlbnRDaGFubmVsLmVtaXQoJ2FjY2VwdERhdGFGcm9tT3BlbmVyUGFnZScsIHsgYmlsbDogYmlsbCB9KVxyXG4gICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSxcclxuICAgICAgICBnZXRCaWxscygpOiB2b2lke1xyXG4gICAgICAgICAgICBpZighdGhpcy5kYXRhLmxlZGdlcklkKXtcclxuICAgICAgICAgICAgICAgIHJldHVyblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmKHRoaXMuZGF0YS5sb2FkaW5nKXtcclxuICAgICAgICAgICAgICAgIHJldHVyblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICBsb2FkaW5nOiB0cnVlXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIHd4LnNob3dMb2FkaW5nKHtcclxuICAgICAgICAgICAgICAgIHRpdGxlOiAn5Yqg6L295LitJ1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICBnZXRCaWxscyh0aGlzLmRhdGEubGVkZ2VySWQsIHRoaXMuZGF0YS5wYXJhbXMpLnRoZW4ocmVzPT57XHJcbiAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUJpbGxzUmVzKHJlcylcclxuICAgICAgICAgICAgICAgIHd4LmhpZGVMb2FkaW5nKClcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9hZGluZzogZmFsc2VcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSxcclxuICAgICAgICBoYW5kbGVCaWxsc1JlcyhyZXM6IEFueU9iamVjdCk6IHZvaWR7XHJcbiAgICAgICAgICAgIGNvbnN0IGxpc3QgPSByZXMubGlzdCBhcyBBbnlBcnJheVxyXG4gICAgICAgICAgICBjb25zdCBkYXRlQ291bnQgPSByZXMuZGF0ZV9jb3VudCBhcyBBbnlBcnJheVxyXG4gICAgICAgICAgICBjb25zdCBtb250aENvdW50ID0gcmVzLm1vbnRoX2NvdW50IGFzIEFueUFycmF5XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGVNYXAgPSB7fSBhcyBSZWNvcmQ8c3RyaW5nLCBBbnlPYmplY3Q+XHJcbiAgICAgICAgICAgIGRhdGVDb3VudC5mb3JFYWNoKGl0ZW09PntcclxuICAgICAgICAgICAgICAgIGRhdGVNYXBbdGhpcy5nZXREYXRlS2V5KGl0ZW0uZGF0ZSldID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIGxpc3Q6W10sXHJcbiAgICAgICAgICAgICAgICAgICAgdG90YWw6IGl0ZW0udG90YWwsXHJcbiAgICAgICAgICAgICAgICAgICAgc3VtSW46IGl0ZW0uc3VtX2luLFxyXG4gICAgICAgICAgICAgICAgICAgIHN1bU91dDogaXRlbS5zdW1fb3V0LFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgbGlzdC5mb3JFYWNoKCBpdGVtID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGRhdGUgPSBkYXRlTWFwW3RoaXMuZ2V0RGF0ZUtleShpdGVtLmJpbGxfdGltZSldXHJcbiAgICAgICAgICAgICAgICBpZihkYXRlLmxpc3Qpe1xyXG4gICAgICAgICAgICAgICAgICAgIGRhdGUubGlzdC5wdXNoKGl0ZW0pXHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHd4LnNob3dUb2FzdCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOiBcIuiuoeaVsOWHuumUmVwiXHJcbiAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgICAgIHRvdGFsOiByZXMudG90YWwsXHJcbiAgICAgICAgICAgICAgICBkYXRlTWFwLFxyXG4gICAgICAgICAgICAgICAgZGF0ZU1hcEtleXM6IE9iamVjdC5rZXlzKGRhdGVNYXApLFxyXG4gICAgICAgICAgICAgICAgbW9udGhNYXA6IG1vbnRoQ291bnRbMF0gfHwge30sXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICBcclxuICAgICAgICB9LFxyXG4gICAgICAgIGdldERhdGVLZXkoaW9zZGF0ZTogc3RyaW5nKTogc3RyaW5ne1xyXG4gICAgICAgICAgICBjb25zdCBkYXRlID0gbmV3IERhdGUoaW9zZGF0ZSlcclxuICAgICAgICAgICAgbGV0IGRhdGVLZXkgPSBmb3JtYXRNb250aERhdGUoZGF0ZSkgKyBcIiAg5pif5pyfXCIgKyB0aGlzLmRhdGEubG9jYWxEYXlbZGF0ZS5nZXREYXkoKV1cclxuICAgICAgICAgICAgaWYoZm9ybWF0TW9udGhEYXRlKGRhdGUpID09IGZvcm1hdE1vbnRoRGF0ZShuZXcgRGF0ZSgpKSl7XHJcbiAgICAgICAgICAgICAgICBkYXRlS2V5ID0gXCLku4rml6UgIOaYn+acn1wiICsgdGhpcy5kYXRhLmxvY2FsRGF5W25ldyBEYXRlKCkuZ2V0RGF5KCldXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGRhdGVLZXlcclxuICAgICAgICB9LFxyXG4gICAgICAgIG9uQWRkKCk6IHZvaWR7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICBjdXJFZGl0SXRlbToge30sXHJcbiAgICAgICAgICAgICAgICBhY3Rpb25UeXBlOiAnYWRkJyxcclxuICAgICAgICAgICAgICAgIGtleWJvYXJkU2hvdzogdHJ1ZVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH0sXHJcbiAgXHJcbiAgICAgICAgb25DbG9zZSgpOiB2b2lke1xyXG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICAgICAga2V5Ym9hcmRTaG93OiBmYWxzZVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIG9uU2F2ZSgpOiB2b2lke1xyXG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICAgICAga2V5Ym9hcmRTaG93OiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIHNsaWRlUmVzZXQ6IHRydWUsXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIHRoaXMuZ2V0QmlsbHMoKVxyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIG9uQ2xpY2tEZWxldGUoZSk6IHZvaWR7XHJcbiAgICAgICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzXHJcbiAgICAgICAgICAgIGNvbnN0IGlkID0gZS5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaWRcclxuICAgICAgICAgICAgRGlhbG9nKHtcclxuICAgICAgICAgICAgICAgIHNob3dDYW5jZWxCdXR0b246IHRydWUsXHJcbiAgICAgICAgICAgICAgICB0aXRsZTogJ+aPkOekuicsXHJcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiAn56Gu5a6a6KaB5Yig6Zmk5ZCX77yfJyxcclxuICAgICAgICAgICAgICAgIGFzeW5jQ2xvc2U6IHRydWVcclxuICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZihEaWFsb2cuY29uZmlybSlcclxuICAgICAgICAgICAgICAgICAgICBkZWxCaWxsKGlkKS50aGVuKF89PntcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoRGlhbG9nLmNsb3NlKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBEaWFsb2cuY2xvc2UoKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmdldEJpbGxzKClcclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICApXHJcbiAgICAgICAgICAgIC5jYXRjaCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZihEaWFsb2cuY2xvc2UpXHJcbiAgICAgICAgICAgICAgICBEaWFsb2cuY2xvc2UoKVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICBvbkNsaWNrRWRpdChlKTogdm9pZHtcclxuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgICAgIGN1ckVkaXRJdGVtOiBlLmN1cnJlbnRUYXJnZXQuZGF0YXNldC5pdGVtLFxyXG4gICAgICAgICAgICAgICAgYWN0aW9uVHlwZTogJ2VkaXQnLFxyXG4gICAgICAgICAgICAgICAga2V5Ym9hcmRTaG93OiB0cnVlXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgb25Ub3VjaHN0YXJ0KGUpe1xyXG4gICAgICAgICAgICBjb25zdCBpZCA9IGUuY3VycmVudFRhcmdldC5kYXRhc2V0LmlkXHJcbiAgICAgICAgICAgIGlmKGlkID09IHRoaXMuZGF0YS5sYXN0VG91Y2hJZCl7XHJcbiAgICAgICAgICAgICAgICByZXR1cm5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICAgICAgbGFzdFRvdWNoSWQ6IGlkLFxyXG4gICAgICAgICAgICAgICAgc2xpZGVSZXNldDogdHJ1ZSxcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICBvbk1vbnRoQ2FuY2VsKCk6IHZvaWR7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICBtb250aFNob3c6IGZhbHNlXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSxcclxuICAgICAgICBvbk1vbnRoU2hvdygpOiB2b2lke1xyXG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICAgICAgbW9udGhTaG93OiB0cnVlXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSxcclxuICAgICAgICBvbk1vbnRoQ29uZmlybShlKTogdm9pZHtcclxuICAgICAgICAgICAgY29uc3QgW3lpLCBtaV0gPSBlLmRldGFpbC5pbmRleFxyXG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICAgICAgbW9udGhTaG93OiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIHBpY2tlclZhbDogW3llYXIgLSAyLCB5ZWFyIC0gMSwgeWVhcl1beWldICsgJ+W5tCcgKyAobWkrMSkgKyAn5pyIJyxcclxuICAgICAgICAgICAgICAgIHBhcmFtczoge1xyXG4gICAgICAgICAgICAgICAgICAgIFwicGFnZV9zaXplXCI6IC0xLFxyXG4gICAgICAgICAgICAgICAgICAgIHBhZ2U6MSxcclxuICAgICAgICAgICAgICAgICAgICBtb250aDogbWkgKyAxLFxyXG4gICAgICAgICAgICAgICAgICAgIHllYXI6IFt5ZWFyIC0gMiwgeWVhciAtIDEsIHllYXJdW3lpXVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9LCAoKT0+e1xyXG4gICAgICAgICAgICAgICAgdGhpcy5nZXRCaWxscygpXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG5cclxuXHJcbiAgICB9XHJcblxyXG59KVxyXG5cclxuZXhwb3J0IHsgfVxyXG5cclxuIl19